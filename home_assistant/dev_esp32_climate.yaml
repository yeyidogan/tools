esphome:
  name: esp32-climate
  friendly_name: ESP32-Climate

esp32:
  board: esp32dev
  framework:
    type: esp-idf


# Configure the inputs
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO15
      mode:
        input: true
        pullup: false
      inverted: true
    name: "Input"
    use_interrupt: True
    filters:
      - delayed_on: 100ms
      - delayed_off: 100ms

# Example configuration entry
sensor:
  - platform: dht
    pin: GPIO19
    model: AM2302
    temperature:
      name: "Living Room Temperature"
      id: my_temp_sensor
    humidity:
      name: "Living Room Humidity"
    update_interval: 60s
  - platform: template
    name: "Virtual Temperature"
    id: virtual_temp_sensor
    lambda: |-
      return id(manual_temperature).state;
    update_interval: 1s

# Configure the outputs
output:
  - platform: ledc
    pin: GPIO2
    id: fan_pwm_output
    frequency: 1000Hz
  - platform: gpio
    pin: GPIO0
    id: cooler_output
  - platform: gpio
    pin: GPIO4
    id: heater_output
  - platform: gpio
    pin: GPIO5
    id: fan_low_output
  - platform: gpio
    pin: GPIO25
    id: fan_medium_output
  - platform: gpio
    pin: GPIO26
    id: fan_high_output
  - platform: gpio
    pin: GPIO12
    id: swing_vertical_output
  - platform: gpio
    pin: GPIO14
    id: swing_horizontal_output
  - platform: gpio
    pin: GPIO32
    id: osc_output
  - platform: gpio
    pin: GPIO33
    id: dir_output
  - platform: gpio
    pin: GPIO16
    id: dummy_output


switch:
  - platform: template
    name: "Heat Mode"
    id: heater_switch
    turn_on_action:
      - output.turn_on: heater_output
    turn_off_action:
      - output.turn_off: heater_output

  - platform: template
    name: "Cool Mode"
    id: cooler_switch
    turn_on_action:
      - output.turn_on: cooler_output
    turn_off_action:
      - output.turn_off: cooler_output

# Swing kontrol체
  - platform: template
    name: "Swing Vertical"
    id: swing_vertical_switch
    turn_on_action:
      - output.turn_on: swing_vertical_output
    turn_off_action:
      - output.turn_off: swing_vertical_output

  - platform: template
    name: "Swing Horizontal"
    id: swing_horizontal_switch
    turn_on_action:
      - output.turn_on: swing_horizontal_output
    turn_off_action:
      - output.turn_off: swing_horizontal_output

  - platform: template
    name: "Fan Speed Low"
    id: fan_speed_low_switch
    turn_on_action:
      - output.turn_on: fan_low_output
    turn_off_action:
      - output.turn_off: fan_low_output
  - platform: template
    name: "Fan Speed Medium"
    id: fan_speed_medium_switch
    turn_on_action:
      - output.turn_on: fan_medium_output
    turn_off_action:
      - output.turn_off: fan_medium_output
  - platform: template
    name: "Fan Speed High"
    id: fan_speed_high_switch
    turn_on_action:
      - output.turn_on: fan_high_output
    turn_off_action:
      - output.turn_off: fan_high_output

  - platform: template
    name: "Dummy"
    id: dummy_switch
    turn_on_action:
      - output.turn_on: dummy_output
    turn_off_action:
      - output.turn_off: dummy_output

globals:
  - id: g_int_fan_target_switch_speed
    type: int
    restore_value: no
    initial_value: '0'
  - id: g_int_fan_actual_switch_speed
    type: int
    restore_value: no
    initial_value: '0'

climate:
  - platform: thermostat
    name: "Thermostat Climate Controller"
    id: my_climate
    sensor: virtual_temp_sensor
    min_cooling_off_time: 5s
    min_cooling_run_time: 5s
    min_heating_off_time: 5s
    min_heating_run_time: 5s
    min_idle_time: 5s
    min_fanning_off_time: 5s
    min_fanning_run_time: 5s
    off_mode: 
      - lambda: |-
          auto turn_off = id(pwm_fan).turn_off();
          turn_off.perform();
      - switch.turn_off: cooler_switch
      - switch.turn_off: heater_switch
      - switch.turn_off: fan_speed_low_switch
      - switch.turn_off: fan_speed_medium_switch
      - switch.turn_off: fan_speed_high_switch
      - fan.turn_off: pwm_fan
    cool_action:
      - switch.turn_on: cooler_switch
    heat_action:
      - switch.turn_on: heater_switch
    idle_action:
      - switch.turn_off: cooler_switch
      - switch.turn_off: heater_switch
    heat_cool_mode:
      - switch.turn_off: dummy_switch
    fan_only_action:
      - switch.turn_off: cooler_switch
      - switch.turn_off: heater_switch
      - fan.turn_on: pwm_fan
    min_fan_mode_switching_time: 5s
    startup_delay: true
    fan_mode_off_action:
      - lambda: |-
          id(g_int_fan_target_switch_speed) = 0;
    fan_mode_low_action:
      - fan.turn_on: pwm_fan
      - lambda: |-
          id(g_int_fan_target_switch_speed) = 1;
    fan_mode_medium_action:
      - fan.turn_on: pwm_fan
      - lambda: |-
          id(g_int_fan_target_switch_speed) = 2;
    fan_mode_high_action:
      - fan.turn_on: pwm_fan
      - lambda: |-
          id(g_int_fan_target_switch_speed) = 3;
    fan_mode_auto_action:
      - fan.turn_on: pwm_fan
    swing_off_action:
      - switch.turn_off: swing_horizontal_switch
      - switch.turn_off: swing_vertical_switch
    swing_horizontal_action:
      - switch.turn_on: swing_horizontal_switch
      - switch.turn_off: swing_vertical_switch
    swing_vertical_action:
      - switch.turn_off: swing_horizontal_switch
      - switch.turn_on: swing_vertical_switch
    swing_both_action:
      - switch.turn_on: swing_horizontal_switch
      - switch.turn_on: swing_vertical_switch

    default_preset: Home
    preset:
      - name: Home
        default_target_temperature_low: 20 째C
        default_target_temperature_high: 22 째C

# Fan kontrolu (manuel ayarlanabilir)
fan:
  - platform: speed
    output: fan_pwm_output
    name: "Meeting Room Fan"
    id: pwm_fan
    restore_mode: ALWAYS_OFF
    oscillation_output: osc_output
    direction_output: dir_output
  - platform: binary
    name: "Fan Low"
    output: fan_low_output
  - platform: binary
    name: "Fan Medium"
    output: fan_medium_output
  - platform: binary
    name: "Fan High"
    output: fan_high_output

number:
  - platform: template
    name: "Manual Temperature Input"
    id: manual_temperature
    optimistic: true
    min_value: 0
    max_value: 50
    step: 0.1
    restore_value: false
    mode: slider
    unit_of_measurement: "째C"
    device_class: temperature
    initial_value: 22.4


interval:
  - interval: 2s
    then:
      - lambda: |-
          static int fan_speed = 0;
          float current = id(manual_temperature).state;
          float target = id(my_climate).target_temperature_low;
          float diff = fabs(target - current);

          if (id(my_climate).action == CLIMATE_ACTION_COOLING) {
            target = id(my_climate).target_temperature_high;
            diff = fabs(target - current);
          }
          if (id(my_climate).mode == CLIMATE_MODE_OFF) {
            id(g_int_fan_target_switch_speed) = 0;
          }
          else {
            if (id(my_climate).fan_mode == CLIMATE_FAN_AUTO) {
              if (diff <= 0.5) {
                fan_speed = 10;
              }
              else {
                fan_speed = (diff-0.5)*30 + 10;
              }
              if (fan_speed > 100) {
                fan_speed = 100;
              }

              if (fan_speed < 20) {
                id(g_int_fan_target_switch_speed) = 1;
              }
              else if (fan_speed < 60) {
                id(g_int_fan_target_switch_speed) = 2;
              }
              else {
                id(g_int_fan_target_switch_speed) = 3;
              }
            }

            if (id(my_climate).fan_mode == CLIMATE_FAN_OFF) {
              id(g_int_fan_target_switch_speed) = 0;
            }
            else {
              if (id(g_int_fan_actual_switch_speed) < id(g_int_fan_target_switch_speed)) {
                id(g_int_fan_actual_switch_speed) += 1;
                if (id(g_int_fan_actual_switch_speed) > id(g_int_fan_target_switch_speed)) {
                  id(g_int_fan_actual_switch_speed) = id(g_int_fan_target_switch_speed);
                }
                id(fan_speed_low_switch).turn_off();
                id(fan_speed_medium_switch).turn_off();
                id(fan_speed_high_switch).turn_off();
                vTaskDelay(500/portTICK_PERIOD_MS);
              }
              else if (id(g_int_fan_actual_switch_speed) > id(g_int_fan_target_switch_speed)) {
                id(g_int_fan_actual_switch_speed) -= 1;
                if (id(g_int_fan_actual_switch_speed) < id(g_int_fan_target_switch_speed)) {
                  id(g_int_fan_actual_switch_speed) = id(g_int_fan_target_switch_speed);
                }
                id(fan_speed_low_switch).turn_off();
                id(fan_speed_medium_switch).turn_off();
                id(fan_speed_high_switch).turn_off();
                vTaskDelay(500/portTICK_PERIOD_MS);
              }
            }
          }

          if (id(g_int_fan_actual_switch_speed) == 0) {
            id(fan_speed_low_switch).turn_off();
            id(fan_speed_medium_switch).turn_off();
            id(fan_speed_high_switch).turn_off();
            auto call = id(pwm_fan).make_call();
            call.set_speed(0);
            call.perform();
            auto turn_off = id(pwm_fan).turn_off();
            turn_off.perform();
          }
          else if (id(g_int_fan_actual_switch_speed) == 1) {
            id(fan_speed_low_switch).turn_on();
            auto call = id(pwm_fan).make_call();
            call.set_speed(20);
            call.perform();
          }
          else if (id(g_int_fan_actual_switch_speed) == 2) {
            id(fan_speed_medium_switch).turn_on();
            auto call = id(pwm_fan).make_call();
            call.set_speed(60);
            call.perform();
          }
          else if (id(g_int_fan_actual_switch_speed) == 3) {
            id(fan_speed_high_switch).turn_on();
            auto call = id(pwm_fan).make_call();
            call.set_speed(100);
            call.perform();
          }

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "GSpzSeXxc74i2dNzd2jmaxIc0AB2az8MUM8Sgu6ctmA="

ota:
  - platform: esphome
    password: "Yilmaz"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Esp32S-Climate Fallback Hotspot"
    password: "Asx12345678?."

captive_portal:
    